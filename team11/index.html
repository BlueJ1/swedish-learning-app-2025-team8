<script>
  function setIframeInteractive(on) {
    const wrap  = document.querySelector('.popup-frame-wrap');
    const frame = document.querySelector('.popup-frame');
    if (!wrap || !frame) return;
    wrap.style.pointerEvents  = on ? 'auto' : 'none';
    frame.style.pointerEvents = on ? 'auto' : 'none';
  }

  const popupFrame = document.getElementById('popupFrame');

  // --- helpers ---
  const normalizeKey = v => (v == null ? '' : String(v)).trim().toLowerCase();

  const keyFromImgPath = (p) => {
    if (!p) return undefined;
    const base = p.split('/').pop() || '';
    return normalizeKey(base.split('.')[0]); // ".../food/beer.png" -> "beer"
  };

  // Build [{id, sv}] in the SAME id-key the clicks / drops use (filename basename)
  function mapWordsFromState(gs) {
    const raw = Array.isArray(gs?.shoppingList) ? gs.shoppingList : [];
    const words = raw.map(item => {
      const idKey =
        keyFromImgPath(item?.img) ||
        (item?.id != null ? normalizeKey(item.id) : undefined) ||
        (item?.en ? normalizeKey(item.en) : undefined) ||
        (item?.sv ? normalizeKey(item.sv) : undefined);

      const svLabel = item?.sv ?? item?.en ?? '';
      return { id: idKey, sv: svLabel };
    }).filter(w => !!w.id);
    return words;
  }

  // ui.js calls this when an image is clicked OR dropped (same path)
  window.sendPickToPopup = function(idKey) {
    if (!popupFrame || !popupFrame.contentWindow) return;
    const id = normalizeKey(idKey);
    console.log('[parent] sending pick (key):', id);
    popupFrame.contentWindow.postMessage({ type: 'pick', id }, '*');
  };

  // --- handshake / gating ---
  let popupIsReady = false;
  let initSent = false;

  function haveShoppingList() {
    const gs = window.__team11GameState;
    return !!(gs && Array.isArray(gs.shoppingList) && gs.shoppingList.length > 0);
  }

  function tryInitPopupOnce() {
    if (initSent || !popupIsReady || !haveShoppingList()) return false;

    const gs = window.__team11GameState;
    console.log('[parent] raw shoppingList length:', gs.shoppingList.length);
    console.log('[parent] sample item:', gs.shoppingList[0]);

    const words = mapWordsFromState(gs);
    if (!words.length) {
      console.warn('[parent] mapped words are empty; will keep waiting…');
      return false;
    }

    console.log('[parent] initWords -> popup:', words.map(w => w.id));
    popupFrame?.contentWindow?.postMessage({ type: 'initWords', words }, '*');
    initSent = true;
    return true;
  }

  // 1) Message listener (status + popupReady + pickResult + endgame lifecycle)
  window.addEventListener('message', (event) => {
    const data = event.data || {};
    if (data.type === 'statusUpdate') {
      const s = data.status; if (!s) return;
      document.getElementById('progressPill').textContent = s.progress;
      document.getElementById('firstTryPill').textContent = s.firstTry;
      document.getElementById('mistakesPill').textContent = s.mistakes;
      document.getElementById('targetPill').textContent = s.target;

      // 👇 move the highlight to the current target in the list
      if (typeof s.index === 'number' || typeof s.index === 'string') {
        window.Team11UI?.highlightListIndex?.(s.index);
      }
      return;
    }

    if (data.type === 'popupReady') {
      console.log('[parent] popupReady received');
      popupIsReady = true;
      tryInitPopupOnce();
      return;
    }

    if (data.type === 'endgameOpen') {
      setIframeInteractive(true);
      return;
    }
    if (data.type === 'endgameClose') {
      setIframeInteractive(false);
      return;
    }

    // ✅ New: result of a pick so we know whether to stick the image in the cart
    if (data.type === 'pickResult' && (typeof data.id === 'string' || typeof data.id === 'number')) {
      const id = normalizeKey(data.id);
      if (data.ok) {
        window.Team11UI?.placeItemInCart?.(id);
      } else {
        // Optional: cart “shake”
        // document.querySelector('.cart-dropzone')?.animate([...],{duration:180});
      }
      return;
    }
  });

  // 2) “team11:ready” (from main.js) nudges init when game state is built
  window.addEventListener('team11:ready', () => {
    console.log('[parent] team11:ready received');
    tryInitPopupOnce();
  });

  // 3) Final safety: poll briefly until both conditions are met
  window.addEventListener('DOMContentLoaded', () => {
    popupFrame?.addEventListener('load', () => tryInitPopupOnce());
    let attempts = 0;
    const timer = setInterval(() => {
      if (tryInitPopupOnce()) { clearInterval(timer); }
      else if (++attempts > 100) {  // ~10s max
        clearInterval(timer);
        console.warn('[parent] Gave up waiting for shoppingList/popup readiness.');
      }
    }, 100);
  });
</script>
